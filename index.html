<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>USAF PT Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {font-family:Arial,Helvetica,sans-serif;margin:0;padding:0 1rem;background:#f2f2f2;}
  .wrapper {max-width:800px;margin:2rem auto;background:#fff;padding:1.5rem;
           border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);}
  h1 {text-align:center;margin-bottom:1.5rem;}
  form {display:flex;flex-direction:column;gap:1.5rem;}
  fieldset {border:1px solid #999;padding:1rem;border-radius:5px;}
  legend {font-weight:bold;padding:0 .5rem;}
  label {display:flex;flex-direction:column;font-weight:600;}
  .radio-group {display:flex;flex-wrap:wrap;gap:.5rem 1.5rem;margin-bottom:1rem;}
  .input-group {margin-top:.5rem;}
  input[type="text"], input[type="number"], select, button {
    width:100%;padding:.6rem;font-size:1rem;
    border:1px solid #999;border-radius:4px;box-sizing:border-box;
  }
  button {background:#005A9C;color:#fff;cursor:pointer;font-weight:600;margin-top:1rem;}
  button:hover {background:#003087;}
  .result {margin-top:2rem;padding:1rem;border:2px solid #444;background:#fafafa;border-radius:5px;}
  .pass {color:#006400;font-weight:bold;}
  .fail {color:#C8102E;font-weight:bold;}
  @media (max-width:400px){
    h1{font-size:1.5rem}
    select,button,input{font-size:.95rem}
  }
</style>
</head>
<body>
<div class="wrapper">
  <h1>USAF PT Calculator</h1>
  <form id="ptForm">
    <!-- ====================== DEMOGRAPHICS ====================== -->
    <fieldset>
      <legend>Demographics</legend>
      <label>Gender
        <select id="gender" required>
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
      </label>
      <label>Age (years)
        <input type="number" id="age" min="17" max="80" required placeholder="e.g., 27" inputmode="numeric">
      </label>
    </fieldset>

    <!-- ====================== COMPONENTS ====================== -->
    <fieldset>
      <legend>Cardio Component</legend>
      <div class="radio-group">
          <label><input type="radio" name="cardio" value="run" checked> 2‑Mile Run</label>
          <label><input type="radio" name="cardio" value="hamr"> HAMR Shuttle</label>
      </div>
      <div class="input-group">
        <label id="cardio-label">Run Time (mm:ss)</label>
        <input type="text" id="cardio-input" placeholder="e.g., 14:30" inputmode="tel" required>
      </div>
    </fieldset>

    <fieldset>
      <legend>Upper-Body Component</legend>
      <div class="radio-group">
        <label><input type="radio" name="upper" value="pushups" checked> Push‑ups (1 min)</label>
        <label><input type="radio" name="upper" value="handRelease"> Hand-Release Push‑ups (2 min)</label>
      </div>
      <div class="input-group">
        <label>Repetitions</label>
        <input type="number" id="upper-input" placeholder="e.g., 45" inputmode="numeric" required>
      </div>
    </fieldset>

    <fieldset>
      <legend>Core Component</legend>
      <div class="radio-group">
        <label><input type="radio" name="core" value="situps" checked> Sit‑ups (1 min)</label>
        <label><input type="radio" name="core" value="crunch"> Cross-Leg Reverse Crunch (2 min)</label>
        <label><input type="radio" name="core" value="plank"> Forearm Plank</label>
      </div>
      <div class="input-group">
        <label id="core-label">Repetitions</label>
        <input type="text" id="core-input" placeholder="e.g., 50" inputmode="numeric" required>
      </div>
    </fieldset>

    <fieldset>
      <legend>Waist-to-Height Ratio (WHtR)</legend>
      <label>Waist (inches)
        <input type="number" id="waist" min="10" max="80" step="0.1" required placeholder="e.g., 34" inputmode="numeric">
      </label>
      <label>Height (inches)
        <input type="number" id="height" min="48" max="84" step="0.1" required placeholder="e.g., 70" inputmode="numeric">
      </label>
    </fieldset>

    <button type="submit">Calculate Score</button>
  </form>
  <div id="output" class="result" style="display:none;"></div>
</div>

<script>
// ========================================================================
// DATA LOADING
// ========================================================================
let PT_DATA = null;
fetch('usaf_pt_charts_clean.json')
  .then(response => {
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    return response.json();
  })
  .then(data => {
    PT_DATA = data;
    console.log('✅ USAF PT data loaded successfully.');
  })
  .catch(error => {
    console.error('❌ Failed to load or parse PT data:', error);
    alert('CRITICAL ERROR: Could not load PT data file `usaf_pt_charts_clean.json`. The calculator cannot function. Check the console for details.');
  });

// ========================================================================
// HELPER FUNCTIONS
// ========================================================================
const mmssToSec = str => { const [m = 0, s = 0] = str.split(':').map(Number); return m * 60 + s; };
const getAgeBucket = age => {
  if (age < 25) return "<25"; if (age <= 29) return "25-29";
  if (age <= 34) return "30-34"; if (age <= 39) return "35-39";
  if (age <= 44) return "40-44"; if (age <= 49) return "45-49";
  if (age <= 54) return "50-54"; if (age <= 59) return "55-59";
  return "60+";
};

// ========================================================================
// SCORE LOOKUP LOGIC
// ========================================================================
const lookupNumeric = (table, value) => {
  if (!table) return 0;
  const tiers = Object.keys(table).map(Number).sort((a, b) => b - a);
  for (const tier of tiers) {
    if (value >= tier) return table[tier];
  }
  return 0;
};

const lookupRunTime = (table, userTimeSec) => {
  if (!table) return 0;
  const tiers = Object.keys(table).map(time => [mmssToSec(time), table[time]]).sort((a, b) => a[0] - b[0]);
  for (const [tierSec, points] of tiers) {
    if (userTimeSec <= tierSec) return points;
  }
  return 0;
};

const lookupWhtr = (waist, height) => {
    if (height === 0) return { pts: 0, ratio: "N/A", category: "Invalid Height" };
    const ratio = (waist / height).toFixed(2);
    const WHTR_TABLE = PT_DATA.whtr;
    const tiers = Object.keys(WHTR_TABLE).map(Number).sort((a, b) => a - b);
    for (const tier of tiers) {
        if (ratio <= tier) {
            const category = ratio <= 0.49 ? "Low Risk" : ratio < 0.55 ? "Moderate Risk" : "High Risk";
            return { pts: WHTR_TABLE[tier.toFixed(2)], ratio, category };
        }
    }
    return { pts: 0, ratio, category: "High Risk" };
};

// ========================================================================
// DYNAMIC UI UPDATES & INPUT FORMATTING
// ========================================================================

// NEW FUNCTION: Auto-adds a colon for time inputs
const handleTimeInput = (event) => {
    const input = event.target;
    const id = input.id;
    let isTimeField = false;

    // Determine if the current input should be formatted as time
    if (id === 'cardio-input' && document.querySelector('input[name="cardio"]:checked').value === 'run') {
        isTimeField = true;
    } else if (id === 'core-input' && document.querySelector('input[name="core"]:checked').value === 'plank') {
        isTimeField = true;
    }

    if (isTimeField) {
        // Get only the digits from the input
        const digits = input.value.replace(/\D/g, '').substring(0, 4);
        let formattedValue = digits;
        if (digits.length > 2) {
            // Insert colon after the first two digits
            formattedValue = `${digits.substring(0, 2)}:${digits.substring(2)}`;const updateInputLabel = (radioName, mappings) => {
    document.querySelectorAll(`input[name="${radioName}"]`).forEach(radio => {
        radio.addEventListener('change', (e) => {
            const { label, placeholder, inputmode } = mappings[e.target.value];
            const labelEl = document.getElementById(`${radioName}-label`);
            const inputEl = document.getElementById(`${radioName}-input`);
            if (labelEl) labelEl.textContent = label;
            if (inputEl) {
                inputEl.placeholder = placeholder;
                inputEl.value = '';
                inputEl.inputmode = inputmode;
                // Since the input type might change, we re-apply the correct type attribute
                inputEl.type = (inputmode === 'numeric' && radioName !== 'core') ? 'number' : 'text';
            }
        });
    });
};

updateInputLabel('cardio', {
    run:  { label: 'Run Time (mm:ss)', placeholder: 'e.g., 14:30', inputmode: 'tel'},
    hamr: { label: 'HAMR Shuttles', placeholder: 'e.g., 65', inputmode: 'numeric'}
});

updateInputLabel('core', {
    situps:  { label: 'Repetitions', placeholder: 'e.g., 50', inputmode: 'numeric' },
    crunch:  { label: 'Repetitions', placeholder: 'e.g., 40', inputmode: 'numeric' },
    plank:   { label: 'Plank Time (mm:ss)', placeholder: 'e.g., 2:15', inputmode: 'tel' }
});


// ========================================================================
// FORM SUBMISSION & CALCULATION
// ========================================================================
document.getElementById('ptForm').addEventListener('submit', (e) => {
  e.preventDefault();
  if (!PT_DATA) {
    alert('Data is not loaded yet. Please wait a moment and try again.');
    return;
  }

  // --- GET USER INPUT & CHOICES ---
  const gender = document.getElementById('gender').value;
  const age = parseInt(document.getElementById('age').value, 10);
  const waist = parseFloat(document.getElementById('waist').value);
  const height = parseFloat(document.getElementById('height').value);
  
  const cardioChoice = document.querySelector('input[name="cardio"]:checked').value;
  const upperChoice = document.querySelector('input[name="upper"]:checked').value;
  const coreChoice = document.querySelector('input[name="core"]:checked').value;

  const cardioInput = document.getElementById('cardio-input').value;
  const upperInput = parseInt(document.getElementById('upper-input').value, 10);
  const coreInput = document.getElementById('core-input').value;

  // --- VALIDATE INPUT ---
  if (isNaN(age) || isNaN(waist) || isNaN(height)) {
    return alert('Please fill out all Age, Waist, and Height fields with valid numbers.');
  }
  const bucket = getAgeBucket(age);
  const bucketData = PT_DATA[gender][bucket];
  if (!bucketData) {
    return alert(`Sorry, scoring data for the ${gender}, age ${age} bracket is not available in the JSON file.`);
  }

  // --- CALCULATE POINTS ---
  let cardioPts = 0, cardioDisplay = cardioInput;
  if (cardioChoice === 'run') {
      if (!/^\d{1,2}:\d{2}$/.test(cardioInput)) return alert('Run time must be in mm:ss format.');
      cardioPts = lookupRunTime(bucketData.run, mmssToSec(cardioInput));
  } else {
      cardioPts = lookupNumeric(bucketData.run, parseInt(cardioInput, 10));
      cardioDisplay = `${parseInt(cardioInput, 10)} shuttles`;
  }
  
  const upperPts = lookupNumeric(bucketData[upperChoice], upperInput);

  let corePts = 0, coreDisplay = coreInput;
  if (coreChoice === 'plank') {
    if (!/^\d{1,2}:\d{2}$/.test(coreInput)) return alert('Plank time must be in mm:ss format.');
    corePts = lookupRunTime(bucketData.plank, mmssToSec(coreInput)); // Plank is also a time lookup
    coreDisplay = coreInput;
  } else {
    corePts = lookupNumeric(bucketData[coreChoice], parseInt(coreInput, 10));
    coreDisplay = `${parseInt(coreInput, 10)} reps`;
  }

  const whtrInfo = lookupWhtr(waist, height);

  // --- CALCULATE TOTAL & CHECK MINIMUMS ---
  const totalScore = cardioPts + upperPts + corePts + whtrInfo.pts;
  const mins = PT_DATA.minimumComponentValues;
  
  const passedCardio = cardioPts >= mins.run;
  const passedUpper = upperPts >= mins[upperChoice];
  const passedCore = corePts >= mins[coreChoice];
  const passedWhtr = whtrInfo.pts >= mins.whtr;
  const passedComposite = totalScore >= PT_DATA.compositeCategories.satisfactoryMin;

  const isPass = passedCardio && passedUpper && passedCore && passedWhtr && passedComposite;

  // --- DISPLAY RESULTS ---
  const getResultLine = (label, display, points, passed) =>
    `<p>${label} (${display}): <strong>${points.toFixed(1)} pts</strong> ${passed ? '✅' : '❌'}</p>`;

  const outputDiv = document.getElementById('output');
  outputDiv.style.display = 'block';
  outputDiv.innerHTML = `
    <h2>Result (${gender.charAt(0).toUpperCase() + gender.slice(1)}, Age ${age})</h2>
    ${getResultLine(cardioChoice === 'run' ? '2-Mile Run' : 'HAMR Shuttle', cardioDisplay, cardioPts, passedCardio)}
    ${getResultLine(upperChoice === 'pushups' ? 'Push-ups' : 'Hand-Release', `${upperInput} reps`, upperPts, passedUpper)}
    ${getResultLine(coreChoice === 'plank' ? 'Plank' : (coreChoice === 'situps' ? 'Sit-ups' : 'Reverse Crunch'), coreDisplay, corePts, passedCore)}
    ${getResultLine(`WHtR`, `${whtrInfo.ratio} – ${whtrInfo.category}`, whtrInfo.pts, passedWhtr)}
    <hr>
    <p><strong>Total Score:</strong> ${totalScore.toFixed(1)} pts</p>
    <p class="${isPass ? 'pass' : 'fail'}">
      <strong>Overall Result: ${isPass ? 'PASS' : 'FAIL'}</strong><br>
      <small>${passedComposite ? 'Composite score met.' : 'Composite score not met.'} You must meet all component minimums and achieve a total score of ${PT_DATA.compositeCategories.satisfactoryMin} or higher.</small>
    </p>
  `;
  outputDiv.scrollIntoView({ behavior: 'smooth' });
});
</script>
</body>
</html>
