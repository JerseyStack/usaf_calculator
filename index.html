<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>USAF PT Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {font-family:Arial,Helvetica,sans-serif;margin:0;padding:0 1rem;background:#f2f2f2;}
  .wrapper {max-width:800px;margin:2rem auto;background:#fff;padding:1.5rem;
           border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);}
  h1 {text-align:center;margin-bottom:1.5rem;}
  form {display:flex;flex-direction:column;gap:1rem;}
  fieldset {border:1px solid #999;padding:1rem;border-radius:5px;}
  legend {font-weight:bold;padding:0 .5rem;}
  label {display:flex;flex-direction:column;font-weight:600;margin-top:.5rem;}
  .test-select {margin-top:.5rem;}
  select, button {width:100%;padding:.6rem;font-size:1rem;
                 border:1px solid #999;border-radius:4px;box-sizing:border-box;}
  button {background:#0066cc;color:#fff;cursor:pointer;font-weight:600;}
  button:hover {background:#0055aa;}
  .result {margin-top:2rem;padding:1rem;border:2px solid #444;background:#fafafa;}
  .pass {color:#0a0;font-weight:bold;}
  .fail {color:#c00;font-weight:bold;}
  @media (max-width:380px){
    h1{font-size:1.5rem}
    select, button{font-size:.95rem}
  }
</style>
</head>
<body>
<div class="wrapper">
  <h1>USAF PT Calculator</h1>

  <form id="ptForm">

    <!-- ====================== GENDER & AGE ====================== -->
    <fieldset>
      <legend>Demographics</legend>
      <label>Gender
        <select id="gender" required>
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
      </label>

      <label>Age (years)
        <input type="number" id="age" min="17" max="80" required placeholder="e.g. 27">
      </label>
    </fieldset>

    <!-- ====================== CARDIO SECTION ====================== -->
    <fieldset>
      <legend>Cardio – Choose ONE</legend>

      <label><input type="radio" name="cardio" value="run" checked> 2‑Mile Run</label>
      <label><input type="radio" name="cardio" value="hamr"> HAMR (20‑m Shuttle)</label>

      <!-- Run dropdown (visible when “run” radio is selected) -->
      <select id="runSelect" class="test-select"></select>

      <!-- HAMR dropdown (visible when “hamr” radio is selected) -->
      <select id="hamrSelect" class="test-select" style="display:none;"></select>
    </fieldset>

    <!-- ====================== PUSH‑UPS SECTION ====================== -->
    <fieldset>
      <legend>Upper‑Body – Choose ONE</legend>

      <label><input type="radio" name="push" value="pushups" checked> Push‑ups (1 min)</label>
      <label><input type="radio" name="push" value="handRelease"> Hand‑Release Push‑ups (2 min)</label>

      <select id="pushSelect" class="test-select"></select>
      <select id="handSelect" class="test-select" style="display:none;"></select>
    </fieldset>

    <!-- ====================== CORE SECTION ====================== -->
    <fieldset>
      <legend>Core – Choose ONE</legend>

      <label><input type="radio" name="core" value="situps" checked> Sit‑ups (1 min)</label>
      <label><input type="radio" name="core" value="crunch"> Reverse Crunch (2 min)</label>
      <label><input type="radio" name="core" value="plank"> Forearm Plank (seconds)</label>

      <select id="sitSelect" class="test-select"></select>
      <select id="crunchSelect" class="test-select" style="display:none;"></select>
      <select id="plankSelect" class="test-select" style="display:none;"></select>
    </fieldset>

    <!-- ====================== WHtR ====================== -->
    <h3>Waist‑to‑Height Ratio (WHtR)</h3>
    <label>Waist (inches)
      <input type="number" id="waist" min="10" max="80" required placeholder="e.g. 34">
    </label>

    <label>Height (inches)
      <input type="number" id="height" min="48" max="84" required placeholder="e.g. 70">
    </label>

    <button type="submit">Calculate Score</button>
  </form>

  <div id="output" class="result" style="display:none;"></div>
</div>

<script>
/* --------------------------------------------------------------
   Helper functions
   -------------------------------------------------------------- */
function mmssToSec(str){ const [m,s] = str.split(':').map(Number); return m*60+s; }

function getAgeBucket(age){
  if (age < 25) return "<25";
  if (age <= 29) return "25-29";
  if (age <= 34) return "30-34";
  if (age <= 39) return "35-39";
  if (age <= 44) return "40-44";
  if (age <= 49) return "45-49";
  if (age <= 54) return "50-54";
  if (age <= 59) return "55-59";
  return "60+";
}

/* Numeric lookup – greatest key ≤ value */
function lookupNumeric(table, val){
  const keys = Object.keys(table).map(Number).sort((a,b)=>a-b);
  let pts = 0;
  for (let i = keys.length-1; i >= 0; i--) {
    if (val >= keys[i]) { pts = table[keys[i]]; break; }
  }
  return pts;
}

/* Run‑time lookup – smallest time ≥ value */
function lookupRun(table, secs){
  const rows = Object.entries(table)
    .map(([k,v])=>[mmssToSec(k),v])
    .sort((a,b)=>a[0]-b[0]);
  let pts = 0;
  for (let i = rows.length-1; i >= 0; i--) {
    if (secs <= rows[i][0]) { pts = rows[i][1]; break; }
  }
  return pts;
}

/* WHtR ladder – same for every bucket */
const WHTR_TABLE = {
  "0.49":20,"0.50":19,"0.51":18,"0.52":17,"0.53":16,"0.54":15,
  "0.55":12.5,"0.56":10,"0.57":7.5,"0.58":5,"0.59":2.5,"0.60":0
};
function lookupWhtr(waist, height){
  const ratio = (waist/height).toFixed(2);
  const keys = Object.keys(WHTR_TABLE).map(Number).sort((a,b)=>a-b);
  let pts = 0, category = "High Risk";
  for (let i = keys.length-1; i >= 0; i--) {
    if (ratio <= keys[i]) {
      pts = WHTR_TABLE[keys[i].toFixed(2)];
      category = (keys[i] <= 0.49) ? "Low Risk"
                : (keys[i] < 0.60) ? "Moderate Risk"
                : "High Risk";
      break;
    }
  }
  return {pts, ratio, category};
}

/* --------------------------------------------------------------
   Load the JSON data (must be served via HTTP)
   -------------------------------------------------------------- */
let PT_DATA = null;
fetch('usaf_pt_charts_clean.json')
  .then(r => {
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  })
  .then(data => {
    PT_DATA = data;
    console.log('✅ PT data loaded');
    buildAllDropdowns();                 // Populate every select once we have the data
  })
  .catch(err => {
    console.error('❌ Failed to load PT data:', err);
    alert('Failed to load PT data – check the console for details.');
  });

/* --------------------------------------------------------------
   Populate every dropdown (run, hamr, push‑ups, hand‑release, …)
   -------------------------------------------------------------- */
function buildAllDropdowns(){
  const gender = document.getElementById('gender').value;
  const age    = Number(document.getElementById('age').value) || 20; // provisional
  const bucket = getAgeBucket(age);
  const bucketData = PT_DATA[gender][bucket];

  // ----- Run -----
  const runSel = document.getElementById('runSelect');
  runSel.innerHTML = '';
  for (const t of Object.keys(bucketData.run).sort((a,b)=>mmssToSec(a)-mmssToSec(b))) {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = `${t} (${bucketData.run[t]} pts)`;
    runSel.appendChild(opt);
  }

  // ----- HAMR (same table as run, just displayed as “shuttle count”) -----
  const hamrSel = document.getElementById('hamrSelect');
  hamrSel.innerHTML = '';
  for (const t of Object.keys(bucketData.run).sort((a,b)=>mmssToSec(a)-mmssToSec(b))) {
    // Convert the run‑time to an approximate shuttle count for display.
    // The PDF gives a range; we simply reuse the same values.
    const opt = document.createElement('option');
    opt.value = t;                // keep the same value – lookupRun works on seconds
    opt.textContent = `${t} (${bucketData.run[t]} pts)`;
    hamrSel.appendChild(opt);
  }

  // ----- Push‑ups -----
  const pushSel = document.getElementById('pushSelect');
  pushSel.innerHTML = '';
  for (const rep of Object.keys(bucketData.pushups).sort((a,b)=>Number(a)-Number(b))) {
    const opt = document.createElement('option');
    opt.value = rep;
    opt.textContent = `${rep} reps (${bucketData.pushups[rep]} pts)`;
    pushSel.appendChild(opt);
  }

  // ----- Hand‑Release -----
  const handSel = document.getElementById('handSelect');
  handSel.innerHTML = pushSel.innerHTML;   // same table for males/females

  // ----- Sit‑ups -----
  const sitSel = document.getElementById('sitSelect');
  sitSel.innerHTML = '';
  for (const rep of Object.keys(bucketData.situps).sort((a,b)=>Number(a)-Number(b))) {
    const opt = document.createElement('option');
    opt.value = rep;
    opt.textContent = `${rep} reps (${bucketData.situps[rep]} pts)`;
    sitSel.appendChild(opt);
  }

  // ----- Reverse Crunch (same table as sit‑ups) -----
  const crunchSel = document.getElementById('crunchSelect');
  crunchSel.innerHTML = sitSel.innerHTML;

  // ----- Plank -----
  const plankSel = document.getElementById('plankSelect');
  plankSel.innerHTML = '';
  for (const sec of Object.keys(bucketData.plank).sort((a,b)=>Number(a)-Number(b))) {
    const opt = document.createElement('option');
    opt.value = sec;
    opt.textContent = `${sec} sec (${bucketData.plank[sec]} pts)`;
    plankSel.appendChild(opt);
  }
}

/* --------------------------------------------------------------
   Show / hide the correct dropdown when a radio button changes
   -------------------------------------------------------------- */
function bindRadioVisibility(radioName, mapping){
  const radios = document.querySelectorAll(`input[name="${radioName}"]`);
  radios.forEach(r => r.addEventListener('change', () => {
    Object.entries(mapping).forEach(([value, selectId]) => {
      document.getElementById(selectId).style.display = (r.value === value) ? 'block' : 'none';
    });
  }));
}

/* Bind visibility logic for the three sections */
bindRadioVisibility('cardio', {run:'runSelect', hamr:'hamrSelect'});
bindRadioVisibility('push',   {pushups:'pushSelect', handRelease:'handSelect'});
bindRadioVisibility('core',   {situps:'sitSelect', crunch:'crunchSelect', plank:'plankSelect'});

/* --------------------------------------------------------------
   Form submit – calculate the PT score
   -------------------------------------------------------------- */
document.getElementById('ptForm').addEventListener('submit', e => {
  e.preventDefault();
  if (!PT_DATA) { alert('Data not loaded yet'); return; }

  const gender = document.getElementById('gender').value;
  const age    = Number(document.getElementById('age').value);
  const bucket = getAgeBucket(age);
  const bucketData = PT_DATA[gender][bucket];
  if (!bucketData) return alert(`No data for ${gender} age ${age}`);

  /* ----- Determine which test was chosen in each section ----- */
  const cardioChoice = document.querySelector('input[name="cardio"]:checked').value;
  const pushChoice   = document.querySelector('input[name="push"]:checked').value;
  const coreChoice   = document.querySelector('input[name="core"]:checked').value;

  /* ----- Pull the selected values from the appropriate dropdowns ----- */
  const runStr   = cardioChoice === 'run'   ? document.getElementById('runSelect').value
                                                : document.getElementById('hamrSelect').value;
  const pushVal  = pushChoice   === 'pushups' ? Number(document.getElementById('pushSelect').value)
                                                : Number(document.getElementById('handSelect').value);
  const sitVal   = coreChoice   === 'situps'  ? Number(document.getElementById('sitSelect').value)
                                                : coreChoice === 'crunch' ? Number(document.getElementById('crunchSelect').value)
                                                : 0;                     // plank uses a different scale
  const plankSec = coreChoice   === 'plank'   ? Number(document.getElementById('plankSelect').value)
                                                : 0;

  const waist    = Number(document.getElementById('waist').value);
  const height   = Number(document.getElementById('height').value);

  /* ----- Basic validation ----- */
  if (!/^[0-9]{1,2}:[0-5][0-9]$/.test(runStr)) {
    return alert('Run/HAMR time must be in mm:ss format (seconds 00‑59).');
  }
  if (waist <= 0 || height <= 0) {
    return alert('Enter valid waist and height numbers.');
  }

  /* ----- Look‑ups ----- */
  const runPts   = lookupRun(bucketData.run, mmssToSec(runStr));
  const pushPts  = lookupNumeric(bucketData.pushups, pushVal);
  const sitPts   = coreChoice === 'plank' ? 0 : lookupNumeric(bucketData.situps, sitVal);
  const plankPts = coreChoice === 'plank' ? lookupNumeric(bucketData.plank, plankSec) : 0;
  const whtrInfo = lookupWhtr(waist, height);   // {pts, ratio, category}
  const total = runPts + pushPts + sitPts + plankPts + whtrInfo.pts;

  /* ----- Apply Minimum‑Component thresholds from JSON ----- */
  const mins = PT_DATA.minimumComponentValues;
  const passed = (total >= PT_DATA.compositeCategories.satisfactoryMin) &&
                 (runPts   >= mins.run) &&
                 (pushPts  >= mins.pushups) &&
                 (sitPts   >= mins.situps) &&
                 (plankPts >= mins.plank) &&
                 (whtrInfo.pts >= mins.whtr);

  /* ----- Display result ----- */
  const out = document.getElementById('output');
  out.style.display = 'block';
  out.innerHTML = `
    <h2>Result (${gender.toUpperCase()}, Age ${age})</h2>
    <p><strong>Run / HAMR (${runStr}):</strong> ${runPts} pts</p>
    <p><strong>${pushChoice === 'pushups' ? 'Push‑ups' : 'Hand‑Release'}:</strong> ${pushVal} reps → ${pushPts} pts</p>
    <p><strong>${coreChoice === 'situps' ? 'Sit‑ups' :
                coreChoice === 'crunch' ? 'Reverse Crunch' : 'Plank'}:</strong>
        ${coreChoice === 'plank' ? plankSec + ' sec' : sitVal + ' reps'}
        → ${coreChoice === 'plank' ? plankPts : sitPts} pts</p>
    <p><strong>WHtR (${whtrInfo.ratio} – ${whtrInfo.category}):</strong> ${whtrInfo.pts} pts</p>
    <p><strong>Total:</strong> ${total} pts</p>
    <p class="${passed ? 'pass' : 'fail'}">
      ${passed ? 'PASS – you meet the composite and component minimums' : 'FAIL – you did not meet the required thresholds'}
    </p>
  `;
});
</script>
</body>
</html>
