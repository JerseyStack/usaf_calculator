<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>USAF PT Demo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:sans-serif;padding:1rem;}
  label{display:block;margin-top:1rem;}
  input,select,button{width:100%;padding:.5rem;}
  .result{margin-top:2rem;padding:1rem;border:2px solid #444;}
</style>
</head>
<body>
<h1>USAF PT Demo</h1>
<form id="ptForm">
  <label>Gender
    <select id="gender"><option value="male">Male</option><option value="female">Female</option></select>
  </label>
  <label>Age <input type="number" id="age" required></label>
  <label>2‑Mile Run (mm:ss) <input type="text" id="runTime" pattern="[0-9]{1,2}:[0-5][0-9]" required></label>
  <label>Sit‑ups <input type="number" id="situps" required></label>
  <label>Push‑ups <input type="number" id="pushups" required></label>
  <label>Waist (in) <input type="number" id="waist" required></label>
  <label>Height (in) <input type="number" id="height" required></label>
  <button type="submit">Calculate</button>
</form>

<div id="out" class="result" style="display:none;"></div>

<script>
/* ---------- fetch the JSON ---------- */
let PT_DATA = null;
fetch('usaf_pt_charts_clean.json')
  .then(r => {
    console.log('Fetch status', r.status);
    return r.json();
  })
  .then(data => {
    PT_DATA = data;
    console.log('JSON loaded – keys', Object.keys(PT_DATA));
  })
  .catch(err => console.error('Load error', err));

/* ---------- helpers ---------- */
function mmssToSec(s){ const [m,sec]=s.split(':').map(Number); return m*60+sec; }
function getAgeBucket(a){
  if(a<25) return "<25";
  if(a<=29) return "25-29";
  if(a<=34) return "30-34";
  if(a<=39) return "35-39";
  if(a<=44) return "40-44";
  if(a<=49) return "45-49";
  if(a<=54) return "50-54";
  if(a<=59) return "55-59";
  return "60+";
}
function lookupRun(tbl, secs){
  const rows = Object.entries(tbl).map(([k,v])=>[mmssToSec(k),v]).sort((a,b)=>a[0]-b[0]);
  let pts = 0;
  for(let i=rows.length-1;i>=0;i--) if(secs<=rows[i][0]) { pts = rows[i][1]; break; }
  return pts;
}
function lookupNumeric(tbl,val){
  const keys = Object.keys(tbl).map(Number).sort((a,b)=>a-b);
  for(let i=keys.length-1;i>=0;i--) if(val>=keys[i]) return tbl[keys[i]];
  return 0;
}
const WHR_TABLE = {"0.49":20,"0.50":19,"0.51":18,"0.52":17,"0.53":16,"0.54":15,
                  "0.55":12.5,"0.56":10,"0.57":7.5,"0.58":5,"0.59":2.5,"0.60":0};
function lookupWHR(w,h){
  const r = (w/h).toFixed(2);
  const keys = Object.keys(WHR_TABLE).map(Number).sort((a,b)=>a-b);
  for(let i=keys.length-1;i>=0;i--) if(r<=keys[i]) return {pts:WHR_TABLE[keys[i].toFixed(2)],ratio:r};
  return {pts:0,ratio:r};
}

/* ---------- form submit ---------- */
document.getElementById('ptForm').addEventListener('submit',e=>{
  e.preventDefault();
  if(!PT_DATA){ alert('Data not loaded yet'); return; }

  const gender = document.getElementById('gender').value;
  const age    = Number(document.getElementById('age').value);
  const runStr = document.getElementById('runTime').value.trim();
  const sit    = Number(document.getElementById('situps').value);
  const push   = Number(document.getElementById('pushups').value);
  const waist  = Number(document.getElementById('waist').value);
  const height = Number(document.getElementById('height').value);

  const bucket = getAgeBucket(age);
  const bucketData = PT_DATA[gender][bucket];
  if(!bucketData){ alert('No data for that age/gender'); return; }

  const runPts   = lookupRun(bucketData.run, mmssToSec(runStr));
  const sitPts   = lookupNumeric(bucketData.situps, sit);
  const pushPts  = lookupNumeric(bucketData.pushups, push);
  const whrInfo  = lookupWHR(waist, height);

  const total = runPts + sitPts + pushPts + whrInfo.pts;
  const passed = (total>=75) && (runPts>=5) && (sitPts>=4) && (pushPts>=4) && (whrInfo.pts>=4);

  const out = document.getElementById('out');
  out.style.display='block';
  out.innerHTML = `
    <p>Run: ${runPts} pts</p>
    <p>Sit‑ups: ${sitPts} pts</p>
    <p>Push‑ups: ${pushPts} pts</p>
    <p>WHtR (${whrInfo.ratio}): ${whrInfo.pts} pts</p>
    <p><strong>Total = ${total}</strong></p>
    <p>${passed?'PASS':'FAIL'}</p>`;
});
</script>
</body>
</html>
