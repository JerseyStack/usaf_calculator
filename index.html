<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>USAF PT Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {font-family:Arial,Helvetica,sans-serif;margin:0;padding:0 1rem;background:#f2f2f2;}
  .wrapper {max-width:800px;margin:2rem auto;background:#fff;padding:1.5rem;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);}
  h1 {text-align:center;margin-bottom:1.5rem;}
  form {display:flex;flex-direction:column;gap:1rem;}
  label {display:flex;flex-direction:column;font-weight:600;}
  input, select, button {width:100%;padding:.6rem;font-size:1rem;border:1px solid #999;border-radius:4px;box-sizing:border-box;}
  button {background:#0066cc;color:#fff;cursor:pointer;font-weight:600;}
  button:hover {background:#0055aa;}
  .result {margin-top:2rem;padding:1rem;border:2px solid #444;background:#fafafa;}
  .pass {color:#0a0;font-weight:bold;}
  .fail {color:#c00;font-weight:bold;}
  .toggle {display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem;}
  @media (max-width:380px){
    h1{font-size:1.5rem}
    input,select,button{font-size:.95rem}
  }
</style>
</head>
<body>
<div class="wrapper">
  <h1>USAF PT Calculator</h1>

  <!-- ---------- Mobile toggle ---------- -->
  <div class="toggle">
    <input type="checkbox" id="useSelects" checked>
    <label for="useSelects">Use dropdowns (mobile‑friendly)</label>
  </div>

  <form id="ptForm">
    <!-- Gender & Age -->
    <label>Gender
      <select id="gender" required>
        <option value="male">Male</option>
        <option value="female">Female</option>
      </select>
    </label>

    <label>Age (years)
      <input type="number" id="age" min="17" max="80" required placeholder="e.g. 27">
    </label>

    <!-- ---------- Run / HAMR ---------- -->
    <div id="runSection">
      <label>2‑Mile Run (mm:ss) – or HAMR (seconds)
        <input type="text" id="runTime"
               placeholder="e.g. 13:45"
               pattern="[0-9]{1,2}:[0-5][0-9]" required>
      </label>

      <label class="selectOnly" style="display:none;">Run / HAMR (select)
        <select id="runSelect"></select>
      </label>
    </div>

    <!-- ---------- Push‑ups / Hand‑Release ---------- -->
    <div id="pushSection">
      <label>Push‑ups (1 min) / Hand‑Release (2 min)
        <input type="number" id="pushups" min="0" required placeholder="e.g. 30">
      </label>

      <label class="selectOnly" style="display:none;">Push‑ups / Hand‑Release (select)
        <select id="pushSelect"></select>
      </label>
    </div>

    <!-- ---------- Sit‑ups / Reverse Crunch ---------- -->
    <div id="sitSection">
      <label>Sit‑ups (1 min) / Reverse Crunch (2 min)
        <input type="number" id="situps" min="0" required placeholder="e.g. 45">
      </label>

      <label class="selectOnly" style="display:none;">Sit‑ups / Reverse Crunch (select)
        <select id="sitSelect"></select>
      </label>
    </div>

    <!-- ---------- Plank ---------- -->
    <div id="plankSection">
      <label>Forearm Plank (seconds)
        <input type="number" id="plank" min="0" required placeholder="e.g. 120">
      </label>

      <label class="selectOnly" style="display:none;">Plank (select)
        <select id="plankSelect"></select>
      </label>
    </div>

    <!-- ---------- WHtR ---------- -->
    <h3>Waist‑to‑Height Ratio (WHtR)</h3>
    <label>Waist (inches)
      <input type="number" id="waist" min="10" max="80" required placeholder="e.g. 34">
    </label>

    <label>Height (inches)
      <input type="number" id="height" min="48" max="84" required placeholder="e.g. 70">
    </label>

    <button type="submit">Calculate Score</button>
  </form>

  <div id="output" class="result" style="display:none;"></div>
</div>

<script>
/* --------------------------------------------------------------
   Helper functions
   -------------------------------------------------------------- */
function mmssToSec(str){ const [m,s] = str.split(':').map(Number); return m*60+s; }
function secToMmss(sec){ const m = Math.floor(sec/60); const s = sec%60; return `${m}:${s.toString().padStart(2,'0')}`; }

function getAgeBucket(age){
  if (age < 25) return "<25";
  if (age <= 29) return "25-29";
  if (age <= 34) return "30-34";
  if (age <= 39) return "35-39";
  if (age <= 44) return "40-44";
  if (age <= 49) return "45-49";
  if (age <= 54) return "50-54";
  if (age <= 59) return "55-59";
  return "60+";
}

/* Numeric lookup – greatest key ≤ value */
function lookupNumeric(table, val){
  const keys = Object.keys(table).map(Number).sort((a,b)=>a-b);
  let pts = 0;
  for (let i = keys.length-1; i >= 0; i--) {
    if (val >= keys[i]) { pts = table[keys[i]]; break; }
  }
  return pts;
}

/* Run‑time lookup – smallest time ≥ value */
function lookupRun(table, secs){
  const rows = Object.entries(table)
    .map(([k,v])=>[mmssToSec(k),v])
    .sort((a,b)=>a[0]-b[0]);
  let pts = 0;
  for (let i = rows.length-1; i >= 0; i--) {
    if (secs <= rows[i][0]) { pts = rows[i][1]; break; }
  }
  return pts;
}

/* WHtR ladder – same for every bucket */
const WHTR_TABLE = {
  "0.49":20,"0.50":19,"0.51":18,"0.52":17,"0.53":16,"0.54":15,
  "0.55":12.5,"0.56":10,"0.57":7.5,"0.58":5,"0.59":2.5,"0.60":0
};
function lookupWhtr(waist, height){
  const ratio = (waist/height).toFixed(2);
  const keys = Object.keys(WHTR_TABLE).map(Number).sort((a,b)=>a-b);
  let pts = 0, category = "High Risk";
  for (let i = keys.length-1; i >= 0; i--) {
    if (ratio <= keys[i]) {
      pts = WHTR_TABLE[keys[i].toFixed(2)];
      category = (keys[i] <= 0.49) ? "Low Risk"
                : (keys[i] < 0.60) ? "Moderate Risk"
                : "High Risk";
      break;
    }
  }
  return {pts, ratio, category};
}

/* --------------------------------------------------------------
   Load the JSON data (must be served via HTTP)
   -------------------------------------------------------------- */
let PT_DATA = null;
fetch('usaf_pt_charts_clean.json')
  .then(r => {
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  })
  .then(data => {
    PT_DATA = data;
    console.log('✅ PT data loaded');
    populateSelects();               // <-- fill all dropdowns once data is ready
  })
  .catch(err => {
    console.error('❌ Failed to load PT data:', err);
    alert('Failed to load PT data – check the console for details.');
  });

/* --------------------------------------------------------------
   Populate the dropdowns (run, push‑ups, sit‑ups, plank)
   -------------------------------------------------------------- */
function populateSelects(){
  const gender = document.getElementById('gender').value;
  const age = Number(document.getElementById('age').value) || 20;   // fallback for early load
  const bucket = getAgeBucket(age);
  const bucketData = PT_DATA[gender][bucket];

  // ----- Run / HAMR -----
  const runSel = document.getElementById('runSelect');
  runSel.innerHTML = '';
  for (const t of Object.keys(bucketData.run).sort((a,b)=>mmssToSec(a)-mmssToSec(b))) {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = `${t} (${bucketData.run[t]} pts)`;
    runSel.appendChild(opt);
  }

  // ----- Push‑ups / Hand‑Release -----
  const pushSel = document.getElementById('pushSelect');
  pushSel.innerHTML = '';
  const pushTable = gender === 'male' ? bucketData.pushups : bucketData.pushups; // same key name in JSON
  for (const rep of Object.keys(pushTable).sort((a,b)=>Number(a)-Number(b))) {
    const opt = document.createElement('option');
    opt.value = rep;
    opt.textContent = `${rep} reps (${pushTable[rep]} pts)`;
    pushSel.appendChild(opt);
  }

  // ----- Sit‑ups / Reverse Crunch -----
  const sitSel = document.getElementById('sitSelect');
  sitSel.innerHTML = '';
  const sitTable = gender === 'male' ? bucketData.situps : bucketData.situps;
  for (const rep of Object.keys(sitTable).sort((a,b)=>Number(a)-Number(b))) {
    const opt = document.createElement('option');
    opt.value = rep;
    opt.textContent = `${rep} reps (${sitTable[rep]} pts)`;
    sitSel.appendChild(opt);
  }

  // ----- Plank -----
  const plankSel = document.getElementById('plankSelect');
  plankSel.innerHTML = '';
  for (const sec of Object.keys(bucketData.plank).sort((a,b)=>Number(a)-Number(b))) {
    const opt = document.createElement('option');
    opt.value = sec;
    opt.textContent = `${sec} sec (${bucketData.plank[sec]} pts)`;
    plankSel.appendChild(opt);
  }
}

/* --------------------------------------------------------------
   Toggle between “type‑in” and “select” UI
   -------------------------------------------------------------- */
document.getElementById('useSelects').addEventListener('change', e => {
  const useSelect = e.target.checked;
  document.querySelectorAll('.selectOnly').forEach(lbl => lbl.style.display = useSelect ? 'block' : 'none');
  document.querySelectorAll('#runSection input, #pushSection input, #sitSection input, #plankSection input')
    .forEach(inp => inp.style.display = useSelect ? 'none' : 'block');

  // If we just switched to selects, make sure they are up‑to‑date
  if (useSelect) populateSelects();
});

/* --------------------------------------------------------------
   Form submit handler
   -------------------------------------------------------------- */
document.getElementById('ptForm').addEventListener('submit', e => {
  e.preventDefault();
  if (!PT_DATA) { alert('Data not loaded yet'); return; }

  const gender   = document.getElementById('gender').value;
  const age      = Number(document.getElementById('age').value);
  const bucket   = getAgeBucket(age);
  const bucketData = PT_DATA[gender][bucket];
  if (!bucketData) return alert(`No data for ${gender} age ${age}`);

  const useSelect = document.getElementById('useSelects').checked;

  /* ----- Pull values (either from input or from dropdown) ----- */
  const runStr   = useSelect
        ? document.getElementById('runSelect').value
        : document.getElementById('runTime').value.trim();

  const pushVal  = useSelect
        ? Number(document.getElementById('pushSelect').value)
        : Number(document.getElementById('pushups').value);

  const sitVal   = useSelect
        ? Number(document.getElementById('sitSelect').value)
        : Number(document.getElementById('situps').value);

  const plankSec = useSelect
        ? Number(document.getElementById('plankSelect').value)
        : Number(document.getElementById('plank').value);

  const waist    = Number(document.getElementById('waist').value);
  const height   = Number(document.getElementById('height').value);

  /* ----- Basic validation ----- */
  if (!/^[0-9]{1,2}:[0-5][0-9]$/.test(runStr)) {
    return alert('Run time must be in mm:ss format (seconds 00‑59).');
  }
  if (waist <= 0 || height <= 0) {
    return alert('Enter valid waist and height numbers.');
  }

  /* ----- Look‑ups ----- */
  const runPts   = lookupRun(bucketData.run, mmssToSec(runStr));
  const pushPts  = lookupNumeric(bucketData.pushups, pushVal);
  const sitPts   = lookupNumeric(bucketData.situps, sitVal);
  const plankPts = lookupNumeric(bucketData.plank, plankSec);
  const whtrInfo = lookupWhtr(waist, height);   // {pts, ratio, category}
  const total = runPts + pushPts + sitPts + plankPts + whtrInfo.pts;

  /* ----- Minimum‑component thresholds (taken from JSON) ----- */
  const mins = PT_DATA.minimumComponentValues;
  const passed = (total >= PT_DATA.compositeCategories.satisfactoryMin) &&
                 (runPts   >= mins.run) &&
                 (pushPts  >= mins.pushups) &&
                 (sitPts   >= mins.situps) &&
                 (plankPts >= mins.plank) &&
                 (whtrInfo.pts >= mins.whtr);

  /* ----- Display result ----- */
  const out = document.getElementById('output');
  out.style.display = 'block';
  out.innerHTML = `
    <h2>Result (${gender.toUpperCase()}, Age ${age})</h2>
    <p><strong>Run (2 mi):</strong> ${runStr} → <strong>${runPts}</strong> pts</p>
    <p><strong>Push‑ups / Hand‑Release:</strong> ${pushVal} → <strong>${pushPts}</strong> pts</p>
    <p><strong>Sit‑ups / Reverse Crunch:</strong> ${sitVal} → <strong>${sitPts}</strong> pts</p>
    <p><strong>Plank:</strong> ${plankSec} sec → <strong>${plankPts}</strong> pts</p>
    <p><strong>WHtR (${whtrInfo.ratio} – ${whtrInfo.category}):</strong> <strong>${whtrInfo.pts}</strong> pts</p>
    <p><strong>Total:</strong> ${total} pts</p>
    <p class="${passed ? 'pass' : 'fail'}">
      ${passed ? 'PASS – you meet the composite and component minimums' : 'FAIL – you did not meet the required thresholds'}
    </p>
  `;
});
</script>
</body>
</html>
